---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getHomePage, getBlogPosts } from '../lib/wagtail';

// R√©cup√©rer les donn√©es depuis Wagtail
const homepage = await getHomePage();
const blogPosts = await getBlogPosts(3);

// DEBUG : R√©cup√©rer la config pour l'afficher
const API_URL = import.meta.env.PUBLIC_WAGTAIL_API_URL;

// Titre de la page
const pageTitle = homepage?.hero_title || 'Accueil Follen';
---

<BaseLayout title={pageTitle}>
    <!-- Banner de debug AVANC√â -->
    {!homepage && (
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 mb-8 overflow-auto">
            <h3 class="font-bold text-lg">üö® DEBUG DIAGNOSTIC</h3>
            
            <div class="mt-4">
                <p><strong>API URL Configur√©e :</strong> {API_URL || 'NON D√âFINIE'}</p>
                <p><strong>Slug cherch√© :</strong> accueil</p>
            </div>

            <div class="mt-4 bg-white p-4 rounded text-xs font-mono border">
                <p class="font-bold mb-2">Instructions pour fixer :</p>
                <ol class="list-decimal ml-4 space-y-1">
                    <li>Copiez l'URL ci-dessous et ouvrez-la dans votre navigateur :</li>
                    <li class="select-all bg-gray-100 p-1 my-1 break-all">
                        {API_URL}/pages/?slug=accueil&fields=hero_title,features&format=json
                    </li>
                    <li>Si cela retourne <code>"items": []</code>, le slug n'est pas "accueil".</li>
                    <li>Si cela retourne une erreur, l'API est inaccessible.</li>
                </ol>
            </div>
        </div>
    )}

    <section class="text-center py-12">
        <h1 class="text-4xl font-bold mb-4">
            {homepage?.hero_title || 'Bienvenue sur Follen'}
        </h1>
        <p class="text-xl mb-8">
            {homepage?.hero_subtitle || 'D√©couvrez des articles passionnants'}
        </p>
        
        {homepage?.hero_cta_text && homepage?.hero_cta_link && (
            <a href={homepage.hero_cta_link} class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                {homepage.hero_cta_text}
            </a>
        )}
    </section>

    <!-- Features depuis Wagtail -->
    {homepage?.features && homepage.features.length > 0 && (
        <div class="grid md:grid-cols-3 gap-6 mt-12">
            {homepage.features.map((feature, index) => (
                <div key={index} class="bg-white p-6 rounded-lg shadow-md">
                    {feature.value?.icon && <div class="text-4xl mb-4">{feature.value.icon}</div>}
                    <h2 class="text-2xl font-semibold mb-2">{feature.value?.title || feature.title}</h2>
                    <p class="text-gray-600">{feature.value?.description || feature.description}</p>
                </div>
            ))}
        </div>
    )}
    
    <!-- Articles de blog -->
    {blogPosts.length > 0 ? (
        <section class="mt-16">
            <h2 class="text-3xl font-bold mb-8 text-center">Derniers articles</h2>
            <div class="grid md:grid-cols-3 gap-6">
                {blogPosts.map((post) => (
                    <article key={post.id} class="bg-white p-6 rounded-lg shadow-md">
                        {post.header_image_thumbnail && (
                            <img src={post.header_image_thumbnail} alt={post.title} class="w-full h-48 object-cover rounded-lg mb-4" />
                        )}
                        <h3 class="text-xl font-semibold mb-2">{post.title}</h3>
                        <p class="text-gray-600 text-sm mb-2">
                            Par {post.author} ‚Ä¢ {new Date(post.date).toLocaleDateString('fr-FR')}
                        </p>
                        <p class="text-gray-600 mb-4">{post.introduction}</p>
                        <a href={`/articles/${post.meta?.slug || post.slug}`} class="text-blue-600 hover:underline">
                            Lire l'article
                        </a>
                    </article>
                ))}
            </div>
        </section>
    ) : (
        <section class="mt-16 text-center text-gray-500">
            <p>Aucun article disponible pour le moment.</p>
        </section>
    )}
</BaseLayout>
