---
/**
 * src/pages/[slug].astro
 * Route dynamique générique pour SectorPage, FormPage, StaticPage
 * SSG: Génère toutes les routes au build via getStaticPaths
 */

import BaseLayout from '../layouts/BaseLayout.astro';
import StreamField from '../components/StreamField.astro';
import DynamicForm from '../components/DynamicForm.astro';
import { 
    getAllSectorPages, 
    getAllFormPages, 
    getAllStaticPages,
    type SectorPage, 
    type FormPage, 
    type StaticPage 
} from '../lib/api';

// ✅ SSG: Lister tous les slugs à générer au build
export async function getStaticPaths() {
    // Récupérer tous les types de pages
    const sectorPages = await getAllSectorPages(100);
    const formPages = await getAllFormPages(100);
    const staticPages = await getAllStaticPages(100);
    
    // Combiner toutes les pages avec leur type
    const allPages = [
        ...sectorPages.map(page => ({ ...page, pageType: 'sector' as const })),
        ...formPages.map(page => ({ ...page, pageType: 'form' as const })),
        ...staticPages.map(page => ({ ...page, pageType: 'static' as const })),
    ];
    
    return allPages.map((page) => ({
        params: { slug: page.meta.slug },
        props: { 
            page,
            pageType: page.pageType,
        }
    }));
}

// Props passées par getStaticPaths
interface Props {
    page: SectorPage | FormPage | StaticPage;
    pageType: 'sector' | 'form' | 'static';
}

const { page, pageType } = Astro.props;

// Fonction utilitaire pour formater une date
function formatDate(dateString: string): string {
    return new Date(dateString).toLocaleDateString('fr-FR', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
    });
}

// Couleurs par secteur/theme
const themeColors: Record<string, { primary: string; light: string; text: string }> = {
    green: { primary: 'bg-follen-green', light: 'bg-follen-green-light', text: 'text-follen-green' },
    blue: { primary: 'bg-follen-blue', light: 'bg-follen-blue-light', text: 'text-follen-blue' },
    yellow: { primary: 'bg-follen-yellow', light: 'bg-follen-yellow-light', text: 'text-amber-600' },
    red: { primary: 'bg-follen-red', light: 'bg-follen-red-light', text: 'text-follen-red' },
};

// Fallback si la page n'existe pas (ne devrait jamais arriver en SSG)
if (!page) {
    return Astro.redirect('/404');
}
---

<BaseLayout title={`${page.title} - FSU`}>
    {pageType === 'sector' && (() => {
        const sectorPage = page as SectorPage;
        const colors = themeColors[sectorPage.color_theme] || themeColors.red;
        
        return (
            <article>
                <!-- ============================================================== -->
                <!-- 1. CONTEXT BANNER                                              -->
                <!-- ============================================================== -->
                {sectorPage.context_banner_text && (
                    <div class={`${colors.primary} text-white py-3 px-4`}>
                        <div class="container mx-auto text-center">
                            <p class="text-sm md:text-base font-medium">{sectorPage.context_banner_text}</p>
                        </div>
                    </div>
                )}

                <!-- ============================================================== -->
                <!-- 2. NEWS GRID (2/3 générales, 1/3 instances)                   -->
                <!-- ============================================================== -->
                {(sectorPage.news_general_list?.length > 0 || sectorPage.news_instance_list?.length > 0) && (
                    <section class="py-12 md:py-16 bg-white" aria-labelledby="news-heading">
                        <div class="container mx-auto px-4 md:px-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Actualités Générales (2/3) -->
                                <div class="lg:col-span-2">
                                    <h2 id="news-heading" class="text-2xl md:text-3xl font-bold text-slate-900 mb-6">
                                        Actualités Générales
                                    </h2>
                                    <div class="grid gap-6 md:grid-cols-2">
                                        {sectorPage.news_general_list?.slice(0, 4).map((article) => (
                                            <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                                                {article.header_image_thumbnail && (
                                                    <a href={`/blog/${article.meta.slug}`} class="block aspect-video overflow-hidden">
                                                        <img 
                                                            src={article.header_image_thumbnail} 
                                                            alt={article.title}
                                                            class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                                                            loading="lazy"
                                                            decoding="async"
                                                        />
                                                    </a>
                                                )}
                                                <div class="p-4">
                                                    <time class="text-sm text-slate-500 mb-2 block">
                                                        {formatDate(article.date)}
                                                    </time>
                                                    <h3 class="text-lg font-bold text-slate-900 mb-2 hover:text-follen-red transition-colors">
                                                        <a href={`/blog/${article.meta.slug}`}>{article.title}</a>
                                                    </h3>
                                                    {article.introduction && (
                                                        <p class="text-slate-600 text-sm line-clamp-2">
                                                            {article.introduction}
                                                        </p>
                                                    )}
                                                </div>
                                            </article>
                                        ))}
                                    </div>
                                </div>

                                <!-- Actualités des Instances (1/3) -->
                                <div class="lg:col-span-1 bg-gray-50 rounded-xl p-6">
                                    <h2 class="text-xl md:text-2xl font-bold text-slate-900 mb-4">
                                        Actualités des Instances
                                    </h2>
                                    <div class="space-y-4">
                                        {sectorPage.news_instance_list?.slice(0, 5).map((news) => (
                                            <article class="pb-4 border-b border-gray-200 last:border-0 last:pb-0">
                                                <time class="text-xs text-slate-500 block mb-1">
                                                    {formatDate(news.date)}
                                                </time>
                                                <h3 class="text-sm font-semibold text-slate-900 hover:text-follen-red transition-colors">
                                                    <a href={`/blog/${news.meta.slug}`}>{news.title}</a>
                                                </h3>
                                            </article>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                )}

                <!-- ============================================================== -->
                <!-- 3. ACTION CARDS ZONE                                           -->
                <!-- ============================================================== -->
                {sectorPage.actions && sectorPage.actions.length > 0 && (
                    <section class="py-16 md:py-20 bg-gray-100" aria-labelledby="actions-heading">
                        <div class="container mx-auto px-4 md:px-6">
                            <h2 id="actions-heading" class="text-2xl md:text-3xl font-bold text-slate-900 text-center mb-10">
                                Nos Actions
                            </h2>
                            <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4 max-w-6xl mx-auto">
                                {sectorPage.actions.slice(0, 4).map((action) => (
                                    <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow text-center">
                                        {action.value?.icon && (
                                            <div class="w-12 h-12 mx-auto mb-4 text-follen-red">
                                                <Fragment set:html={action.value.icon} />
                                            </div>
                                        )}
                                        <h3 class="text-lg font-bold text-slate-900 mb-2">{action.value?.title || action.value}</h3>
                                        {action.value?.description && (
                                            <p class="text-slate-600 text-sm mb-4">{action.value.description}</p>
                                        )}
                                        {action.value?.href && (
                                            <a 
                                                href={action.value.href} 
                                                class="inline-flex items-center text-follen-red hover:text-follen-red/80 font-medium text-sm"
                                            >
                                                {action.value.link_text || 'En savoir plus'}
                                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                </svg>
                                            </a>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </section>
                )}

                <!-- ============================================================== -->
                <!-- 4. CONTACT BANNER (Représentants)                              -->
                <!-- ============================================================== -->
                {sectorPage.representatives_list && sectorPage.representatives_list.length > 0 && (
                    <section class="py-16 bg-white" aria-labelledby="contact-heading">
                        <div class="container mx-auto px-4 md:px-6">
                            <div class="max-w-4xl mx-auto text-center">
                                <h2 id="contact-heading" class="text-2xl md:text-3xl font-bold text-slate-900 mb-10">
                                    Nos Représentants
                                </h2>
                                <div class="flex flex-wrap justify-center gap-8 mb-10">
                                    {sectorPage.representatives_list.map((rep) => (
                                        <figure class="text-center">
                                            <div class="w-20 h-20 md:w-24 md:h-24 rounded-full overflow-hidden border-4 border-follen-red-light shadow-md mx-auto mb-3">
                                                <img 
                                                    src={rep.photo_url} 
                                                    alt={rep.name}
                                                    width="96"
                                                    height="96"
                                                    loading="lazy"
                                                    decoding="async"
                                                    class="w-full h-full object-cover"
                                                />
                                            </div>
                                            <figcaption>
                                                <p class="font-semibold text-slate-900 text-sm md:text-base">{rep.name}</p>
                                                <p class="text-gray-500 text-xs md:text-sm">{rep.role}</p>
                                                {rep.email && (
                                                    <a 
                                                        href={`mailto:${rep.email}`}
                                                        class="text-follen-red text-xs hover:underline"
                                                    >
                                                        {rep.email}
                                                    </a>
                                                )}
                                            </figcaption>
                                        </figure>
                                    ))}
                                </div>
                                <a 
                                    href="/contact" 
                                    class="inline-flex items-center bg-follen-red text-white px-8 py-4 rounded-lg font-semibold hover:bg-follen-red/90 transition-colors shadow-md hover:shadow-lg"
                                >
                                    Nous contacter
                                    <svg class="w-5 h-5 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </section>
                )}
            </article>
        );
    })()}

    {pageType === 'form' && (() => {
        const formPage = page as FormPage;
        return <DynamicForm formPage={formPage} />;
    })()}

    {pageType === 'static' && (() => {
        const staticPage = page as StaticPage;
        return (
            <article class="max-w-4xl mx-auto px-4 py-12">
                {/* Hero Image */}
                {staticPage.header_image_url && (
                    <div class="relative w-full rounded-2xl overflow-hidden shadow-xl aspect-video mb-8">
                        <img 
                            src={staticPage.header_image_url} 
                            alt={staticPage.title}
                            width="1200"
                            height="675"
                            class="w-full h-full object-cover"
                            loading="eager"
                            decoding="async"
                        />
                    </div>
                )}
                
                {/* Title */}
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900">
                        {staticPage.title}
                    </h1>
                </header>
                
                {/* Main Content (StreamField) */}
                {staticPage.content && staticPage.content.length > 0 && (
                    <div class="prose prose-slate prose-lg max-w-none">
                        <StreamField blocks={staticPage.content} />
                    </div>
                )}
                
                {/* Back Link */}
                <footer class="mt-12 pt-8 border-t border-slate-200">
                    <a 
                        href="/" 
                        class="inline-flex items-center gap-2 text-follen-red hover:text-follen-red/80 font-medium transition-colors"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Retour à l'accueil
                    </a>
                </footer>
            </article>
        );
    })()}
</BaseLayout>
