---
/**
 * src/pages/blog/[slug].astro
 * Page dynamique pour les articles (ArticlePage)
 * SSG: Génère toutes les routes au build via getStaticPaths
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import StreamField from '../../components/StreamField.astro';
import { getAllArticles, getArticleBySlug, type Article } from '../../lib/api';

// ✅ SSG: Lister tous les slugs d'articles à générer au build
export async function getStaticPaths() {
    const articles = await getAllArticles(100);
    
    return articles.map((article) => ({
        params: { slug: article.meta.slug },
        props: { article }
    }));
}

// Props passées par getStaticPaths
interface Props {
    article: Article;
}

const { article } = Astro.props;

// Couleurs par secteur
const sectorColors: Record<Article['sector'], { primary: string; light: string; text: string }> = {
    agriculture: { primary: 'bg-follen-green', light: 'bg-follen-green-light', text: 'text-follen-green' },
    ecologie: { primary: 'bg-follen-blue', light: 'bg-follen-blue-light', text: 'text-follen-blue' },
    interieur: { primary: 'bg-follen-yellow', light: 'bg-follen-yellow-light', text: 'text-amber-600' },
    general: { primary: 'bg-follen-red', light: 'bg-follen-red-light', text: 'text-follen-red' }
};

const colors = sectorColors[article.sector] || sectorColors.general;

function formatDate(dateString: string): string {
    return new Date(dateString).toLocaleDateString('fr-FR', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
    });
}

// Fallback si l'article n'existe pas (ne devrait jamais arriver en SSG)
if (!article) {
    return Astro.redirect('/404');
}
---

<BaseLayout title={`${article.title} - FSU`}>
    <article>
        <!-- ============================================================== -->
        <!-- 1. HERO IMAGE WRAPPER                                          -->
        <!-- ============================================================== -->
        {article.header_image_url && (
            <div class="w-full px-4 md:px-0 md:w-[90%] lg:w-[85%] mx-auto pt-8">
                <figure class="relative">
                    <img 
                        src={article.header_image_url}
                        alt={article.title}
                        width="1600"
                        height="700"
                        loading="eager"
                        decoding="async"
                        class="w-full aspect-[21/9] object-cover rounded-2xl shadow-lg"
                    />
                    <!-- Overlay gradient subtil -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent rounded-2xl"></div>
                </figure>
            </div>
        )}

        <!-- ============================================================== -->
        <!-- 2. FLOATING TITLE CARD (Overlap Effect)                        -->
        <!-- ============================================================== -->
        <div class="w-[92%] md:w-[80%] lg:w-[65%] mx-auto -mt-12 md:-mt-16 lg:-mt-24 relative z-10">
            <header class="bg-white rounded-2xl shadow-xl p-6 md:p-10 lg:p-12">
                <!-- Catégorie + Tags + Date -->
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    {article.category_info && (
                        <span class:list={["text-xs font-bold px-3 py-1 rounded-full", colors.light, colors.text]}>
                            {article.category_info.name}
                        </span>
                    )}
                    {article.tags_list && article.tags_list.length > 0 && (
                        <>
                            {article.tags_list.slice(0, 3).map((tag) => (
                                <span class="text-xs px-2 py-1 bg-slate-100 text-slate-600 rounded-full">
                                    {tag}
                                </span>
                            ))}
                        </>
                    )}
                </div>
                
                <!-- Date + Auteur -->
                <div class="flex flex-wrap items-center gap-3 text-sm text-slate-500 mb-4">
                    {article.date && (
                        <time datetime={article.date} class="flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            {formatDate(article.date)}
                        </time>
                    )}
                    {article.author && (
                        <>
                            <span class="text-slate-300">•</span>
                            <span class="flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                {article.author}
                            </span>
                        </>
                    )}
                </div>
                
                <!-- Titre Principal -->
                <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-slate-900 leading-tight">
                    {article.title}
                </h1>
            </header>
        </div>

        <!-- ============================================================== -->
        <!-- 3. INTRODUCTION (Chapeau)                                      -->
        <!-- ============================================================== -->
        {(article.introduction || article.excerpt) && (
            <div class="w-[92%] md:w-[80%] lg:w-[65%] mx-auto mt-8 md:mt-12">
                <h2 class="text-lg md:text-xl font-semibold text-slate-700 leading-relaxed border-l-4 border-follen-red pl-6">
                    {article.introduction || article.excerpt}
                </h2>
            </div>
        )}

        <!-- ============================================================== -->
        <!-- 4. MAIN CONTENT (StreamField avec Typography)                  -->
        <!-- ============================================================== -->
        {article.body && article.body.length > 0 && (
            <main class="w-[92%] md:w-[80%] lg:w-[65%] mx-auto mt-10 md:mt-14">
                <div class="prose prose-slate prose-lg max-w-none
                           prose-headings:font-bold prose-headings:text-slate-900
                           prose-h3:text-xl prose-h3:mt-10 prose-h3:mb-4
                           prose-p:text-slate-700 prose-p:leading-relaxed
                           prose-a:text-follen-red prose-a:no-underline hover:prose-a:underline
                           prose-ul:my-6 prose-li:text-slate-700
                           prose-blockquote:border-l-4 prose-blockquote:border-follen-red 
                           prose-blockquote:bg-follen-red-light prose-blockquote:py-4 prose-blockquote:px-6 
                           prose-blockquote:rounded-r-lg prose-blockquote:not-italic
                           prose-blockquote:text-slate-800 prose-blockquote:font-medium">
                    <StreamField blocks={article.body} />
                </div>
            </main>
        )}

        <!-- ============================================================== -->
        <!-- 5. RETOUR AUX ARTICLES                                         -->
        <!-- ============================================================== -->
        <div class="w-[92%] md:w-[80%] lg:w-[65%] mx-auto mt-12 pt-8 border-t border-gray-200">
            <a 
                href="/archives" 
                class="inline-flex items-center text-slate-600 hover:text-follen-red transition-colors font-medium"
            >
                <svg class="w-5 h-5 mr-2 rotate-180" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                </svg>
                Retour aux archives
            </a>
        </div>
    </article>

    <!-- ==================================================================== -->
    <!-- 6. CONTACT BANNER (réutiliser le composant existant)                 -->
    <!-- ==================================================================== -->
    <section class="py-16 md:py-20 bg-gray-50 mt-16" aria-labelledby="contact-heading">
        <div class="container mx-auto px-4 md:px-6">
            <div class="max-w-4xl mx-auto text-center">
                <h2 id="contact-heading" class="text-2xl md:text-3xl font-bold text-slate-900 mb-10">
                    Une question ? Contactez-nous
                </h2>
                
                <a 
                    href="/contact" 
                    class="inline-flex items-center bg-follen-red text-white px-8 py-4 rounded-lg font-semibold hover:bg-follen-red/90 transition-colors shadow-md hover:shadow-lg"
                >
                    Nous contacter
                    <svg class="w-5 h-5 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                    </svg>
                </a>
            </div>
        </div>
    </section>
</BaseLayout>

