---
// HeroCarousel.astro - Carrousel Hero Full-Width avec overlay titre

interface Slide {
    title: string;
    image_url: string;
    link: string;
    category?: string;
}

interface Props {
    articles: Slide[];
    interval?: number; // Intervalle en ms (défaut: 5000)
}

const { articles, interval = 5000 } = Astro.props;

// S'assurer qu'on a au moins un article
const slides = articles.length > 0 ? articles : [
    { title: 'Bienvenue sur Follen', image_url: 'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=1920', link: '/', category: 'Découverte' }
];
---

<section class="relative w-full h-[500px] md:h-[600px] lg:h-[700px] overflow-hidden bg-gray-900">
    <!-- Slides Container -->
    <div id="carousel-slides" class="relative w-full h-full">
        {slides.map((slide, index) => (
            <div 
                class:list={[
                    'carousel-slide absolute inset-0 transition-opacity duration-1000 ease-in-out',
                    index === 0 ? 'opacity-100 z-10' : 'opacity-0 z-0'
                ]}
                data-index={index}
            >
                <!-- Image de fond -->
                <img 
                    src={slide.image_url} 
                    alt={slide.title}
                    class="absolute inset-0 w-full h-full object-cover"
                    loading={index === 0 ? 'eager' : 'lazy'}
                />
                <!-- Overlay gradient pour lisibilité -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
            </div>
        ))}
    </div>

    <!-- Bloc Overlay Titre -->
    <div class="absolute bottom-8 left-0 md:bottom-12 md:left-12 z-20 max-w-xl">
        <a href={slides[0].link} id="carousel-link" class="block group">
            <div class="bg-white p-6 md:p-10 shadow-2xl transform transition-transform duration-300 group-hover:translate-x-2">
                <!-- Catégorie -->
                {slides[0].category && (
                    <span 
                        id="carousel-category"
                        class="inline-block text-xs font-semibold uppercase tracking-widest text-emerald-600 mb-3"
                    >
                        {slides[0].category}
                    </span>
                )}
                
                <!-- Titre -->
                <h2 
                    id="carousel-title"
                    class="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 leading-tight mb-4"
                >
                    {slides[0].title}
                </h2>
                
                <!-- CTA -->
                <span class="inline-flex items-center text-emerald-600 font-medium group-hover:gap-3 gap-2 transition-all">
                    Lire l'article
                    <svg class="w-5 h-5 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                </span>
            </div>
        </a>
    </div>

    <!-- Indicateurs de slides -->
    <div class="absolute bottom-8 right-8 md:bottom-12 md:right-12 z-20 flex gap-3">
        {slides.map((_, index) => (
            <button 
                class:list={[
                    'carousel-indicator w-3 h-3 rounded-full transition-all duration-300',
                    index === 0 ? 'bg-white scale-125' : 'bg-white/50 hover:bg-white/75'
                ]}
                data-index={index}
                aria-label={`Slide ${index + 1}`}
            />
        ))}
    </div>

    <!-- Contrôles Prev/Next -->
    <button 
        id="carousel-prev"
        class="absolute left-4 top-1/2 -translate-y-1/2 z-20 p-3 bg-white/20 backdrop-blur-sm rounded-full hover:bg-white/40 transition-colors"
        aria-label="Slide précédent"
    >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </button>
    <button 
        id="carousel-next"
        class="absolute right-4 top-1/2 -translate-y-1/2 z-20 p-3 bg-white/20 backdrop-blur-sm rounded-full hover:bg-white/40 transition-colors"
        aria-label="Slide suivant"
    >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
    </button>
</section>

<script define:vars={{ slides, interval }}>
    document.addEventListener('DOMContentLoaded', () => {
        const slideElements = document.querySelectorAll('.carousel-slide');
        const indicators = document.querySelectorAll('.carousel-indicator');
        const titleEl = document.getElementById('carousel-title');
        const categoryEl = document.getElementById('carousel-category');
        const linkEl = document.getElementById('carousel-link');
        const prevBtn = document.getElementById('carousel-prev');
        const nextBtn = document.getElementById('carousel-next');
        
        let currentIndex = 0;
        let autoPlayInterval = null;
        const totalSlides = slides.length;

        function goToSlide(index) {
            // Normaliser l'index
            if (index < 0) index = totalSlides - 1;
            if (index >= totalSlides) index = 0;
            
            // Mettre à jour les slides
            slideElements.forEach((slide, i) => {
                if (i === index) {
                    slide.classList.remove('opacity-0', 'z-0');
                    slide.classList.add('opacity-100', 'z-10');
                } else {
                    slide.classList.remove('opacity-100', 'z-10');
                    slide.classList.add('opacity-0', 'z-0');
                }
            });
            
            // Mettre à jour les indicateurs
            indicators.forEach((indicator, i) => {
                if (i === index) {
                    indicator.classList.remove('bg-white/50');
                    indicator.classList.add('bg-white', 'scale-125');
                } else {
                    indicator.classList.remove('bg-white', 'scale-125');
                    indicator.classList.add('bg-white/50');
                }
            });
            
            // Mettre à jour le texte de l'overlay INSTANTANÉMENT
            if (titleEl) titleEl.textContent = slides[index].title;
            if (categoryEl) categoryEl.textContent = slides[index].category || '';
            if (linkEl) linkEl.setAttribute('href', slides[index].link);
            
            currentIndex = index;
        }

        function nextSlide() {
            goToSlide(currentIndex + 1);
        }

        function prevSlide() {
            goToSlide(currentIndex - 1);
        }

        function startAutoPlay() {
            stopAutoPlay();
            autoPlayInterval = setInterval(nextSlide, interval);
        }

        function stopAutoPlay() {
            if (autoPlayInterval) {
                clearInterval(autoPlayInterval);
                autoPlayInterval = null;
            }
        }

        // Event listeners
        prevBtn?.addEventListener('click', () => {
            prevSlide();
            startAutoPlay(); // Reset timer
        });

        nextBtn?.addEventListener('click', () => {
            nextSlide();
            startAutoPlay(); // Reset timer
        });

        indicators.forEach((indicator, index) => {
            indicator.addEventListener('click', () => {
                goToSlide(index);
                startAutoPlay(); // Reset timer
            });
        });

        // Pause on hover
        const carousel = document.querySelector('section');
        carousel?.addEventListener('mouseenter', stopAutoPlay);
        carousel?.addEventListener('mouseleave', startAutoPlay);

        // Démarrer l'autoplay
        startAutoPlay();
    });
</script>

